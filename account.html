<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - LinkedIn Automation Tool</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body data-page="account">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <img src="./images/junior-logo.png" alt="Junior Logo" class="logo-img">
            </div>
            <ul class="nav-links">
                <div class="nav-group">
                    <li><a href="index.html#features">Features</a></li>
                    <li><a href="index.html#how-it-works">How It Works</a></li>
                    <li><a href="index.html#pricing">Pricing</a></li>
                </div>
                <div class="nav-actions">
                    <li><a href="index.html" class="my-story-link">‚Üê Back to Home</a></li>
                </div>
            </ul>
        </div>
    </nav>

    <!-- Account Management Section -->
    <section class="account-section" style="padding: 80px 20px; min-height: 80vh;">
        <div class="container" style="max-width: 800px; margin: 0 auto;">
            <div id="loading" style="text-align: center; padding: 60px 20px;">
                <div style="font-size: 3em; margin-bottom: 20px;">‚è≥</div>
                <h2 style="color: #1f2937;">Loading your account...</h2>
            </div>

            <div id="not-logged-in" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 4em; margin-bottom: 20px;">üîí</div>
                <h2 style="color: #1f2937; margin-bottom: 20px;">Please Log In</h2>
                <p style="color: #6b7280; margin-bottom: 30px;">You need to be logged in to view your account.</p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <a href="index.html#pricing" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; border-radius: 8px; text-decoration: none; font-weight: 600;">Go to Home</a>
                    <a href="https://billing.stripe.com/p/login/28EfZjeBvdfSdjF5us3cc00" target="_blank" style="display: inline-block; background: white; color: #667eea; border: 2px solid #667eea; padding: 15px 40px; border-radius: 8px; text-decoration: none; font-weight: 600;">Manage via Stripe</a>
                </div>
                <p style="color: #9ca3af; font-size: 0.9em; margin-top: 20px;">Or log in directly through Stripe to manage your subscription</p>
            </div>

            <div id="account-content" style="display: none;">
                <div style="text-align: center; margin-bottom: 40px;">
                    <h1 style="color: #1f2937; margin-bottom: 10px;">My Account</h1>
                    <p style="color: #6b7280;" id="user-email"></p>
                </div>

                <!-- Subscription Card -->
                <div style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h2 style="color: #1f2937; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span>üí≥</span> Subscription
                    </h2>
                    
                    <div id="subscription-info">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                            <div>
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 5px;">Plan</div>
                                <div style="color: #6b7280;" id="plan-name">Loading...</div>
                            </div>
                            <div id="status-badge" style="padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em;"></div>
                        </div>

                        <div style="margin: 20px 0; padding: 15px; background: #f9fafb; border-radius: 8px;">
                            <div style="color: #6b7280; font-size: 0.9em; margin-bottom: 5px;">Next billing date</div>
                            <div style="font-weight: 600; color: #1f2937;" id="billing-date">Loading...</div>
                        </div>

                        <button id="manage-subscription-btn" onclick="openCustomerPortal()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border: none; border-radius: 8px; font-weight: 600; font-size: 1.05em; cursor: pointer; transition: transform 0.2s; margin-bottom: 12px;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            Manage Subscription
                        </button>
                        <p style="text-align: center; color: #6b7280; font-size: 0.9em; margin-bottom: 15px;">
                            Cancel anytime ‚Ä¢ Update payment method ‚Ä¢ View billing history
                        </p>
                        <div style="text-align: center; padding: 15px; background: #f9fafb; border-radius: 8px;">
                            <p style="color: #6b7280; font-size: 0.9em; margin-bottom: 8px;">You can also manage directly through Stripe:</p>
                            <a href="https://billing.stripe.com/p/login/28EfZjeBvdfSdjF5us3cc00" target="_blank" style="color: #667eea; font-weight: 600; text-decoration: underline;">Stripe Customer Portal ‚Üí</a>
                        </div>
                    </div>
                </div>

                <!-- Download App Card -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 30px; color: white; text-align: center;">
                    <h2 style="margin-bottom: 15px;">üöÄ Download Desktop App</h2>
                    <p style="margin-bottom: 25px; opacity: 0.9;">Start generating AI-powered LinkedIn comments</p>
                    <a href="index.html#pricing" style="display: inline-block; background: white; color: #667eea; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: 600;">Download Now</a>
                </div>
            </div>

            <div id="error-message" style="display: none; text-align: center; padding: 60px 20px;">
                <div style="font-size: 4em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                <h2 style="color: #dc2626; margin-bottom: 20px;">Error Loading Account</h2>
                <p style="color: #6b7280; margin-bottom: 30px;" id="error-text"></p>
                <button onclick="location.reload()" style="background: #667eea; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Try Again</button>
            </div>
        </div>
    </section>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:8000' 
            : 'https://api.heyjunior.ai';

        async function loadAccountData() {
            try {
                // Get token from session storage
                const token = sessionStorage.getItem('userToken');
                
                if (!token) {
                    showNotLoggedIn();
                    return;
                }

                // Fetch account access data
                const response = await fetch(`${API_BASE_URL}/api/payments/account/access`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    showNotLoggedIn();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load account data');
                }

                const data = await response.json();
                displayAccountData(data);

            } catch (error) {
                console.error('Error loading account:', error);
                showError('Failed to load account information. Please try again.');
            }
        }

        function displayAccountData(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('account-content').style.display = 'block';

            // Set user email
            document.getElementById('user-email').textContent = data.email;

            // Set plan name
            const planName = data.tier === 'standard' ? 'Standard Plan - $29.99/month' : 
                           data.tier === 'pro' ? 'Pro Plan - $49.99/month' : 
                           'No Active Plan';
            document.getElementById('plan-name').textContent = planName;

            // Set status badge
            const statusBadge = document.getElementById('status-badge');
            if (data.has_subscription) {
                statusBadge.textContent = 'Active';
                statusBadge.style.background = '#10b981';
                statusBadge.style.color = 'white';
            } else {
                statusBadge.textContent = 'Inactive';
                statusBadge.style.background = '#ef4444';
                statusBadge.style.color = 'white';
            }

            // Set billing date
            if (data.expires_at) {
                const date = new Date(data.expires_at);
                document.getElementById('billing-date').textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } else {
                document.getElementById('billing-date').textContent = 'No active subscription';
            }

            // Store customer ID for portal
            window.stripeCustomerId = data.customer_id;
        }

        function showNotLoggedIn() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('not-logged-in').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-text').textContent = message;
        }

        async function openCustomerPortal() {
            const button = document.getElementById('manage-subscription-btn');
            button.disabled = true;
            button.textContent = 'Opening Portal...';

            try {
                const token = sessionStorage.getItem('userToken');
                const response = await fetch(`${API_BASE_URL}/api/payments/create-portal-session`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        return_url: window.location.href
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create portal session');
                }

                const data = await response.json();
                
                // Redirect to Stripe Customer Portal
                window.location.href = data.url;

            } catch (error) {
                console.error('Error opening portal:', error);
                alert('Failed to open subscription management. Please try again.');
                button.disabled = false;
                button.textContent = 'Manage Subscription';
            }
        }

        // Load account data on page load
        document.addEventListener('DOMContentLoaded', loadAccountData);
    </script>
</body>
</html>

